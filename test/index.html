<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<h1>ViewAssets</h1>

<p>ViewAssets(VA) 是一个简单的 Javascript, Stylesheets 依赖管理器。 根据 Rails 3.2 中的 asset pipeline，它会默认加载所有的 assets 资源，这样其实对于富 JS 应用而言并不是特别有利。因为每个页面有可能都包含着大量其它页面都需要用到的文件资源。VA 就是为了解决这个问题而提出来的。它支持每个页面都能够加载自己需要的 assets 资源，同时也保留了 assets pipeline 自动处理依赖的优点。   </p>

<p>简单的概括这个 gem 就是它将在 view 中 *.html.erb 中声明的依赖转移到 js/css 文件中。在特定的文件(manifest file)中使用规定的语法(directive)声明依赖。   </p>

<h2>Example</h2>

<p>下面的目录是一个 rails 项目的 public 文件夹。</p>

<pre><code>.
├── 404.html
├── 422.html
├── 500.html
├── app
│   ├── javascripts
│   │   ├── application.js
│   │   ├── bar
│   │   │   ├── index
│   │   │   │   ├── index.js
│   │   │   │   └── others.js
│   │   │   └── show.js
│   │   └── foo
│   │       ├── foo.js
│   │       ├── index
│   │       │   ├── index.js
│   │       │   └── others.js
│   │       └── show.js
│   └── stylesheets
│       ├── application.css
│       ├── bar
│       │   ├── index
│       │   │   ├── index.css
│       │   │   └── others.css
│       │   └── show.css
│       └── foo
│           ├── foo.css
│           ├── index
│           │   ├── index.css
│           │   └── others.css
│           └── show.css
├── favicon.ico
├── lib
│   ├── javascripts
│   │   ├── lib1.js
│   │   └── lib2.js
│   └── stylesheets
│       ├── lib1.css
│       └── lib2.css
└── vendor
    ├── javascripts
    │   ├── vendor1.js
    │   └── vendor2.js
    └── stylesheets
        ├── vendor1.css
        └── vendor2.css
</code></pre>

<p>有如下的依赖声明：</p>

<p>/vendor/javascripts/vendor1.js</p>

<div class="highlight"><pre><span class="c1">//= require_vendor vendor2</span>
</pre></div>

<p>/lib/javascripts/lib1.js</p>

<div class="highlight"><pre><span class="c1">//= require_vendor lib2</span>
</pre></div>

<p>/app/javascripts/application.js</p>

<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> *= require_vendor vendor1</span>
<span class="cm"> *= require_lib lib1</span>
<span class="cm"> */</span>
</pre></div>

<p>/app/javascripts/bar/show.js</p>

<div class="highlight"><pre><span class="c1">//= reuquire index/others.js</span>
</pre></div>

<p>当访问 <code>bar/show</code>(比如：<code>localhost:3000/bar/show</code>) 时，可以看到在其 <code>html</code> 文件中的 <code>head</code> 有下面的几个 <code>script</code> 自动插入了：</p>

<pre><code>&lt;script src="vendor2.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="vendor1.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="lib2.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="lib1.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="application.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="index/others.js" type="text/javascript"&gt;&lt;/script&gt;
</code></pre>

<h2>CONVENTIONS/RULES</h2>

<p>使用 rake view_assets:init 任务，VA 会在 public 目录中添加下面的文件结构:</p>

<pre><code>|- vendor
    |- javascripts
    |- stylesheets
|- lib
    |- javascripts
    |- stylesheets
|- app
    |- javascripts
        |-application.js
    |- stylesheets
        |-application.css
</code></pre>

<p>和 rails assets pipeline 相似，它有三种目录存放 js 以及 css 文件。每种类型的含义都和 pipeline 相同。</p>

<pre><code>vendor
用于存放如 Extjs, JQuery 等外部库。

lib
用于存放自己拓展的功能，比如一些拓展于 Extjs 的库或者一些其它公用的拓展功能等。

app
用于存放每个页面需要用到的资源。
</code></pre>

<h3>manifest file</h3>

<p><strong>NOTE</strong><br><br>
下面例子讲述的时候大都直接使用 javascript 当例子，stylesheets 的所有规则几乎和 javascripts 一致。如有不同会单独提示。</p>

<p>manifest file 指的是用于声明文件依赖的文件，<strong>只有在这个文件中声明依赖才是有效的</strong>，因为 VA 只会解析 manifest file，并为你关联好依赖。</p>

<p>三个不同的目录有各自特点的 manifest file。</p>

<h4>In Vendor &amp; Lib</h4>

<p>对于 vendor 和 lib 资源，manifest file 可以是如下形式：</p>

<p>如果该资源只有一个文件，且直接放置于资源根目录下（即 vendor/javascritps 或者 lib/javascritps），则这个文件本身就是 manifest file，我们可以在文件的头部直接添加其文件依赖。</p>

<p>如果该资源有多个文件，且存放于同一个文件夹中，则该文件夹中的 index.js 文件被定义为 manifest file。</p>

<p><strong>NOTE</strong><br><br>
注意同一个文件夹内的依赖不需要声明，因为 VA 会自动将文件中所有的 assets 文件加载进来。</p>

<h4>In App</h4>

<p>对于 app 目录，它有两种 manifest file，一种是 controller 级别的，另一种是 action 级别的。</p>

<p>对于 controlle 级别的 manifest file，VA 类似 rails 的 views，如果这个 controller 本身存在自己的依赖，即（ 存在这个文件 /app/javascripts/:controller/:controller.js），则不会使用 /app/javascripts/application.js。</p>

<p>对于 action，则和 vendor、lib 相似，如果只有一个文件，则 manifest file 为 /app/javascripts/:controller/:action.js，如果该 action 有多个文件，则需要将其组织在以 action 为名的文件夹中，同时在这些中以 index 为名的文件为 manifest file。</p>

<p><strong>NOTE</strong> VA 会自动将 <code>/app/javascripts/:controller/:action</code> 中所有的 assets 文件加载进来。</p>

<h4>Others</h4>

<p>在开发过程中并不一定要使用 manifest file，要注意的是如果有特别依赖要声明的时候，要声明于该文件中，这样 VA 才能正确的为你关联好依赖。</p>

<h2>DIRECTIVE</h2>

<p>同样，VA 也可以在文件中声明依赖，声明的规则基本业余 pipeline 相似。js 中支持三种声明方式，css 中支持两种。</p>

<pre><code>for javascript  
  double-slash syntax =&gt; "//= require_vendor xxx"   
  space-asterisk syntax =&gt; " *= require_vendor xxx"   
  slash-asterisk syntax =&gt; "/*= require_vendor xxx */"  

for stylesheets   
  space-asterisk syntax =&gt; " *= require_vendor xxx"   
  slash-asterisk syntax =&gt; "/*= require_vendor xxx */"  
</code></pre>

<p>上面列出的三种声明方式，而声明指令也有三个，分别是：</p>

<ul>
<li>
<code>require_vendor</code> 会在 vendor 文件夹中寻找目的资源<br>
</li>
<li>
<code>require_lib</code> 会在 lib 文件夹中寻找目的资源<br>
</li>
<li>
<code>require</code> 会在 app 文件夹中寻找目的资源<br>
</li>
</ul>
<p>对于 <code>require</code> 指令，AV 主要提供的是对同一个 controller 下和不同 controller 下的资源进行加载，这些文件都不会被视为 manifest file，所以不会对其进行解析。</p>

<p>加载同一个 controller 的资源时，参数不要包含 controller 名字以及不能以 <code>/</code> 开头，任何以 <code>/</code> 开头的参数在 <code>require</code> 中会视为加载其他 controller 文件。</p>

<p><code>require path/to/file</code></p>

<p>加载不同 controller 的资源时</p>

<p><code>require /other_controller/path/to/file</code></p>

<h2>Arguments/Path</h2>

<p>在 Directive 后跟着的依赖的参数。如：</p>

<div class="highlight"><pre>/**
 * require_vendor vendor1, vendor2        =&gt; <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">"/vendor/javascripts/vendor1.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
 *                                           <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">"/vendor/javascripts/vendor2.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
 *
 * require_lib lib1                       =&gt; <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">"/lib/javascripts/lib1.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
 * require_lib lib2                       =&gt; <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">"/lib/javascripts/lib2.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
 * require /other_controller/path/to/file =&gt; <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">"/app/javascripts/other_controller/path/to/tile.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
 */
</pre></div>

<h2>USAGE</h2>

<p>在 Gemfile 中添加下面的代码：</p>

<p><code>gem 'view_assets'</code></p>

<p>接下来，需要在 <code>/app/helpers/application_helper.rb</code> include <code>ViewAssets</code>。</p>

<div class="highlight"><pre><span class="n">module</span> <span class="n">ApplicationHelper</span>
  <span class="n">include</span> <span class="n">ViewAssets</span>
<span class="k">end</span>
</pre></div>

<p>在你的 <code>/app/views/layouts/application.html.rb</code> 文件中需要添加下面代码：</p>

<div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">include_assets_with_assets_mvc</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:controller</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:action</span><span class="o">]</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>

<p>如果你的 controller 使用了自己的 layout 的话，则需要将在 <code>app/views/layouts/application.html.rb</code> 添加的代码也添加进去。</p>

<h2>OTHERS</h2>

<p>虽然这个 gem 有一定的方便性，但毕竟这是个简单的设计，目前支持简单的依赖管理，并不是个像 assets pipeline 一样十分成熟的程序。目前它还不支持许多 assets pipeline 实现的事情，比如在 production 模式下自动将所有 assets 压缩成一个文件等。</p>

<p>This project rocks and uses MIT-LICENSE.</p>
</body></html>
